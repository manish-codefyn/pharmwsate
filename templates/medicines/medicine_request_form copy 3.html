{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-lg">
                <div class="card-header bg-primary text-white">
                    <h3 class="text-center font-weight-light my-2">Request Medicine: {{ medicine.name }}</h3>
                </div>
                <div class="card-body">
                    <form method="post" id="medicineRequestForm" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <!-- Medicine Info -->
                        <div class="mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Medicine:</strong> {{ medicine.name }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Available Quantity:</strong> {{ medicine.quantity_available }}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quantity and Message -->
                        <div class="mb-4">
                            <h5 class="mb-3">Request Details</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="id_quantity_requested" class="form-label">Quantity Requested*</label>
                                    <input type="number" name="quantity_requested" class="form-control" 
                                           id="id_quantity_requested" min="1" required
                                           placeholder="Enter quantity needed">
                                    <div class="invalid-feedback">
                                        Please provide a valid quantity.
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="id_message" class="form-label">Message (Optional)</label>
                                <textarea name="message" class="form-control" id="id_message" 
                                          rows="3" placeholder="Additional information (optional)"></textarea>
                            </div>
                        </div>
                        
                        <!-- Address Selection -->
                        <div class="mb-4">
                            <h5 class="mb-3">Delivery Address*</h5>
                            
                            {% if user_addresses %}
                            <div class="mb-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="address_option" 
                                           id="existing_address" value="existing" checked>
                                    <label class="form-check-label" for="existing_address">
                                        Use existing address
                                    </label>
                                </div>
                                
                                <div class="row mt-3" id="existing-address-section">
                                    {% for address in user_addresses %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card address-card">
                                            <div class="card-body">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" 
                                                           name="existing_address" id="address_{{ address.id }}" 
                                                           value="{{ address.id }}" {% if forloop.first %}checked{% endif %}>
                                                    <label class="form-check-label" for="address_{{ address.id }}">
                                                        <strong>{{ address.address_line1 }}</strong><br>
                                                        {% if address.address_line2 %}{{ address.address_line2 }}<br>{% endif %}
                                                        {{ address.city }}, {{ address.state }} {{ address.postal_code }}<br>
                                                        {{ address.country }}
                                                        {% if address.is_primary %}<span class="badge bg-primary">Primary</span>{% endif %}
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="address_option" 
                                       id="new_address" value="new" {% if not user_addresses %}checked{% endif %}>
                                <label class="form-check-label" for="new_address">
                                    Add new address
                                </label>
                            </div>
                            
                            <div class="row g-3 {% if user_addresses %}d-none{% endif %}" id="new-address-section">
                                <div class="col-12">
                                    <label for="id_address_line1" class="form-label">Address Line 1*</label>
                                    <input type="text" name="address_line1" class="form-control" 
                                           id="id_address_line1" required
                                           placeholder="Street address, P.O. box, company name">
                                </div>
                                <div class="col-12">
                                    <label for="id_address_line2" class="form-label">Address Line 2</label>
                                    <input type="text" name="address_line2" class="form-control" 
                                           id="id_address_line2"
                                           placeholder="Apartment, suite, unit, building, floor, etc.">
                                </div>
                                <div class="col-md-4">
                                    <label for="id_city" class="form-label">City*</label>
                                    <input type="text" name="city" class="form-control" 
                                           id="id_city" required placeholder="City">
                                </div>
                                <div class="col-md-4">
                                    <label for="id_state" class="form-label">State/Province*</label>
                                    <input type="text" name="state" class="form-control" 
                                           id="id_state" required placeholder="State/Province/Region">
                                </div>
                                <div class="col-md-4">
                                    <label for="id_postal_code" class="form-label">Postal Code*</label>
                                    <input type="text" name="postal_code" class="form-control" 
                                           id="id_postal_code" required placeholder="ZIP/Postal code">
                                </div>
                                <div class="col-md-6">
                                    <label for="id_country" class="form-label">Country*</label>
                                    <input type="text" name="country" class="form-control" 
                                           id="id_country" required placeholder="Country">
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <div class="form-check">
                                        <input type="checkbox" name="is_primary" class="form-check-input" 
                                               id="id_is_primary">
                                        <label class="form-check-label" for="id_is_primary">
                                            Set as primary address
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{% url 'medicines:medicine-detail' slug=medicine.slug %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i> Back
                            </a>
                            <button type="submit" class="btn btn-primary" name="submit_request">
                                <i class="bi bi-send me-2"></i> Submit Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle between existing and new address
    const existingAddressRadio = document.getElementById('existing_address');
    const newAddressRadio = document.getElementById('new_address');
    const existingAddressSection = document.getElementById('existing-address-section');
    const newAddressSection = document.getElementById('new-address-section');
    
    function toggleAddressSections() {
        if (existingAddressRadio.checked) {
            existingAddressSection.classList.remove('d-none');
            newAddressSection.classList.add('d-none');
            // Make new address fields not required
            document.querySelectorAll('#new-address-section [required]').forEach(el => {
                el.removeAttribute('required');
            });
            // Make existing address selection required
            document.querySelector('input[name="existing_address"]:checked').setAttribute('required', 'required');
        } else {
            existingAddressSection.classList.add('d-none');
            newAddressSection.classList.remove('d-none');
            // Remove required from existing address selection
            document.querySelectorAll('input[name="existing_address"]').forEach(el => {
                el.removeAttribute('required');
            });
            // Make new address fields required
            document.querySelectorAll('#new-address-section [required]').forEach(el => {
                el.setAttribute('required', 'required');
            });
        }
    }
    
    // Initialize on page load
    toggleAddressSections();
    
    // Add event listeners
    if (existingAddressRadio) existingAddressRadio.addEventListener('change', toggleAddressSections);
    if (newAddressRadio) newAddressRadio.addEventListener('change', toggleAddressSections);
    
    // Form validation
    const form = document.getElementById('medicineRequestForm');
    if (form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            form.classList.add('was-validated');
        }, false);
    }
});
</script>
{% endblock %}